/*
 * index.js
 * Copyright (C) 2019 Devon Proctor <devon.proctor@gmail.com>
 *
 * Distributed under terms of the MIT license.
 */
import {CircleMode, DirectMode, DragCircleMode, SimpleSelectMode} from 'mapbox-gl-draw-circle';
import '@mapbox/mapbox-gl-draw/dist/mapbox-gl-draw.css'
const mapboxgl = require('mapbox-gl');
const MapboxDraw = require('@mapbox/mapbox-gl-draw');

mapboxgl.accessToken =
    'pk.eyJ1IjoiZHBybyIsImEiOiJjamhrNG03N2gweHFrMzdxb3A3ZXc2MDd2In0.FC_fu8WvE7POuOeYMUGHyg';

const map = new mapboxgl.Map({
  container : 'map',                            // container id
  style : 'mapbox://styles/mapbox/streets-v11', // hosted style id
  center : [ -98.583333, 39.833333 ],           // starting position
  zoom : 3                                      // starting zoom
});

const draw = new MapboxDraw({
  // displayControlsDefault: false,
  // controls: {
  // polygon: true,
  // trash: true
  //},
  defaultMode : "draw_circle",
  userProperties: true,
  modes : {
    draw_circle : CircleMode,
    drag_circle : DragCircleMode,
    direct_select : DirectMode,
    simple_select : SimpleSelectMode
  },
});
map.addControl(draw);

map.on('draw.selectionchange', updateSelection);

function drawCircle(id, centerLon, centerLat, radiusInKm, coordinates) {
  draw.add({
    'id': id,
    'type': 'Feature',
    'properties': {
      'center': [ centerLon, centerLat ],
      'isCircle': true,
      'radiusInKm': radiusInKm,
              "stroke": "#555555",
                  "fill": "#555555",
                  "fill-opacity": 0.5,
    },
    'geometry': { 'type': 'Polygon', 'coordinates': coordinates },
  });
}

map.on('load', function () {
  drawCircle('mom-estimate', -120.81966112500022, 36.15174610451875, 300,
    [ [ [ -120.81966112500021, 38.75954791557352 ], [ -121.14193463585386, 38.7465699261807 ], [ -121.46078098131375, 38.707774413423856 ], [ -121.77282051654176, 38.6435747846433 ], [ -122.0747674148452, 38.55465357614268 ], [ -122.36347358336049, 38.44195292456444 ], [ -122.63596916040663, 38.30666158651281 ], [ -122.88949872870967, 38.15019884184832 ], [ -123.12155258347464, 37.97419567974789 ], [ -123.32989261730457, 37.780473710205825 ], [ -123.51257260912259, 37.571022266521716 ], [ -123.66795291683863, 37.34797416738557 ], [ -123.79470976145878, 37.11358059261943 ], [ -123.89183944507266, 36.87018549759716 ], [ -123.95865796181732, 36.62019995151318 ], [ -123.99479653826467, 36.366076737840984 ], [ -124.00019367954643, 36.11028550517332 ], [ -123.97508430412392, 35.85528870639116 ], [ -123.91998652918424, 35.60351851638958 ], [ -123.83568662671365, 35.35735487533089 ], [ -123.72322261395273, 35.1191047668405 ], [ -123.58386687731127, 34.890982809317705 ], [ -123.41910816122265, 34.675093213662336 ], [ -123.23063318713486, 34.47341314185587 ], [ -123.02030810605831, 34.28777748731178 ], [ -122.7901599329513, 34.1198650888685 ], [ -122.54235806390443, 33.97118638480039 ], [ -122.2791959379731, 33.84307251033257 ], [ -122.0030728743603, 33.736665841003536 ], [ -121.7164760917861, 33.652911984083275 ], [ -121.42196289931951, 33.59255322053401 ], [ -121.1221430355878, 33.55612340026949 ], [ -120.81966112500021, 33.54394429346398 ], [ -120.51717921441265, 33.55612340026949 ], [ -120.21735935068092, 33.59255322053401 ], [ -119.92284615821433, 33.652911984083275 ], [ -119.63624937564013, 33.736665841003536 ], [ -119.36012631202735, 33.84307251033257 ], [ -119.096964186096, 33.97118638480039 ], [ -118.84916231704915, 34.1198650888685 ], [ -118.61901414394212, 34.28777748731178 ], [ -118.40868906286559, 34.47341314185587 ], [ -118.22021408877778, 34.67509321366232 ], [ -118.05545537268917, 34.890982809317705 ], [ -117.9160996360477, 35.1191047668405 ], [ -117.80363562328678, 35.35735487533089 ], [ -117.7193357208162, 35.60351851638958 ], [ -117.66423794587652, 35.85528870639116 ], [ -117.639128570454, 36.11028550517332 ], [ -117.64452571173578, 36.366076737840984 ], [ -117.68066428818312, 36.62019995151318 ], [ -117.74748280492778, 36.87018549759716 ], [ -117.84461248854164, 37.11358059261943 ], [ -117.97136933316182, 37.34797416738557 ], [ -118.12674964087785, 37.571022266521716 ], [ -118.30942963269588, 37.780473710205825 ], [ -118.51776966652581, 37.97419567974789 ], [ -118.74982352129078, 38.15019884184832 ], [ -119.00335308959382, 38.30666158651281 ], [ -119.27584866663996, 38.44195292456444 ], [ -119.56455483515525, 38.55465357614268 ], [ -119.86650173345866, 38.6435747846433 ], [ -120.1785412686867, 38.707774413423856 ], [ -120.49738761414659, 38.7465699261807 ], [ -120.81966112500021, 38.75954791557352 ] ] ]
  );
  drawCircle('chris-estimate', -74.3255204999998, 40.96387554729806, 300,
            [ [ [ -74.32552049999978, 43.57167735835283 ], [ -74.64779401085343, 43.558699368960006 ], [ -74.96664035631332, 43.519903856203165 ], [ -75.27867989154133, 43.45570422742261 ], [ -75.58062678984477, 43.366783018921986 ], [ -75.86933295836006, 43.25408236734375 ], [ -76.1418285354062, 43.11879102929212 ], [ -76.39535810370924, 42.96232828462763 ], [ -76.62741195847421, 42.7863251225272 ], [ -76.83575199230414, 42.592603152985134 ], [ -77.01843198412216, 42.383151709301025 ], [ -77.1738122918382, 42.16010361016488 ], [ -77.30056913645835, 41.92571003539874 ], [ -77.39769882007224, 41.68231494037647 ], [ -77.4645173368169, 41.43232939429249 ], [ -77.50065591326424, 41.17820618062029 ], [ -77.506053054546, 40.92241494795263 ], [ -77.4809436791235, 40.667418149170466 ], [ -77.42584590418382, 40.415647959168886 ], [ -77.34154600171323, 40.1694843181102 ], [ -77.2290819889523, 39.93123420961981 ], [ -77.08972625231084, 39.703112252097014 ], [ -76.92496753622223, 39.487222656441645 ], [ -76.73649256213443, 39.28554258463518 ], [ -76.52616748105788, 39.09990693009109 ], [ -76.29601930795087, 38.93199453164781 ], [ -76.048217438904, 38.7833158275797 ], [ -75.78505531297267, 38.65520195311188 ], [ -75.50893224935987, 38.548795283782844 ], [ -75.22233546678568, 38.465041426862584 ], [ -74.92782227431908, 38.40468266331332 ], [ -74.62800241058737, 38.3682528430488 ], [ -74.32552049999978, 38.35607373624329 ], [ -74.02303858941222, 38.3682528430488 ], [ -73.7232187256805, 38.40468266331332 ], [ -73.4287055332139, 38.465041426862584 ], [ -73.14210875063971, 38.548795283782844 ], [ -72.86598568702692, 38.65520195311188 ], [ -72.60282356109558, 38.7833158275797 ], [ -72.35502169204872, 38.93199453164781 ], [ -72.1248735189417, 39.09990693009109 ], [ -71.91454843786516, 39.28554258463518 ], [ -71.72607346377735, 39.48722265644163 ], [ -71.56131474768874, 39.703112252097014 ], [ -71.42195901104728, 39.93123420961981 ], [ -71.30949499828635, 40.1694843181102 ], [ -71.22519509581578, 40.415647959168886 ], [ -71.1700973208761, 40.667418149170466 ], [ -71.14498794545358, 40.92241494795263 ], [ -71.15038508673535, 41.17820618062029 ], [ -71.1865236631827, 41.43232939429249 ], [ -71.25334217992736, 41.68231494037647 ], [ -71.35047186354122, 41.92571003539874 ], [ -71.47722870816139, 42.16010361016488 ], [ -71.63260901587742, 42.383151709301025 ], [ -71.81528900769545, 42.592603152985134 ], [ -72.02362904152538, 42.7863251225272 ], [ -72.25568289629035, 42.96232828462763 ], [ -72.50921246459339, 43.11879102929212 ], [ -72.78170804163953, 43.25408236734375 ], [ -73.07041421015482, 43.366783018921986 ], [ -73.37236110845824, 43.45570422742261 ], [ -73.68440064368627, 43.519903856203165 ], [ -74.00324698914616, 43.558699368960006 ], [ -74.32552049999978, 43.57167735835283 ] ] ]
  );
  drawCircle('haley-estimate', -77.31380175000034, 40.01921998621387, 300,
            [ [ [ -77.31380175000032, 42.62702179726864 ], [ -77.63607526085397, 42.61404380787582 ], [ -77.95492160631386, 42.575248295118975 ], [ -78.26696114154187, 42.51104866633842 ], [ -78.56890803984531, 42.422127457837796 ], [ -78.8576142083606, 42.30942680625956 ], [ -79.13010978540675, 42.17413546820793 ], [ -79.38363935370978, 42.01767272354344 ], [ -79.61569320847475, 41.84166956144301 ], [ -79.82403324230468, 41.647947591900945 ], [ -80.0067132341227, 41.438496148216835 ], [ -80.16209354183874, 41.21544804908069 ], [ -80.28885038645889, 40.98105447431455 ], [ -80.38598007007278, 40.73765937929228 ], [ -80.45279858681744, 40.4876738332083 ], [ -80.48893716326478, 40.2335506195361 ], [ -80.49433430454654, 39.97775938686844 ], [ -80.46922492912404, 39.722762588086276 ], [ -80.41412715418436, 39.4709923980847 ], [ -80.32982725171377, 39.22482875702601 ], [ -80.21736323895284, 38.98657864853562 ], [ -80.07800750231138, 38.758456691012825 ], [ -79.91324878622277, 38.542567095357455 ], [ -79.72477381213497, 38.34088702355099 ], [ -79.51444873105842, 38.1552513690069 ], [ -79.28430055795141, 37.98733897056362 ], [ -79.03649868890454, 37.83866026649551 ], [ -78.77333656297321, 37.71054639202769 ], [ -78.49721349936041, 37.604139722698655 ], [ -78.21061671678622, 37.520385865778394 ], [ -77.91610352431962, 37.46002710222913 ], [ -77.61628366058791, 37.42359728196461 ], [ -77.31380175000032, 37.4114181751591 ], [ -77.01131983941276, 37.42359728196461 ], [ -76.71149997568104, 37.46002710222913 ], [ -76.41698678321444, 37.520385865778394 ], [ -76.13039000064025, 37.604139722698655 ], [ -75.85426693702746, 37.71054639202769 ], [ -75.59110481109612, 37.83866026649551 ], [ -75.34330294204926, 37.98733897056362 ], [ -75.11315476894224, 38.1552513690069 ], [ -74.9028296878657, 38.34088702355099 ], [ -74.7143547137779, 38.54256709535744 ], [ -74.54959599768928, 38.758456691012825 ], [ -74.41024026104782, 38.98657864853562 ], [ -74.2977762482869, 39.22482875702601 ], [ -74.21347634581632, 39.4709923980847 ], [ -74.15837857087664, 39.722762588086276 ], [ -74.13326919545412, 39.97775938686844 ], [ -74.1386663367359, 40.2335506195361 ], [ -74.17480491318324, 40.4876738332083 ], [ -74.2416234299279, 40.73765937929228 ], [ -74.33875311354176, 40.98105447431455 ], [ -74.46550995816193, 41.21544804908069 ], [ -74.62089026587796, 41.438496148216835 ], [ -74.803570257696, 41.647947591900945 ], [ -75.01191029152592, 41.84166956144301 ], [ -75.24396414629089, 42.01767272354344 ], [ -75.49749371459393, 42.17413546820793 ], [ -75.76998929164007, 42.30942680625956 ], [ -76.05869546015536, 42.422127457837796 ], [ -76.36064235845878, 42.51104866633842 ], [ -76.67268189368681, 42.575248295118975 ], [ -76.9915282391467, 42.61404380787582 ], [ -77.31380175000032, 42.62702179726864 ] ] ]
  );
  drawCircle('devon-estimate', -122.57747362499974, 38.19338911083314, 300,
      [ [ [ -122.57747362499973, 40.80119092188791 ], [ -122.89974713585337, 40.788212932495085 ], [ -123.21859348131326, 40.74941741973824 ], [ -123.53063301654127, 40.68521779095769 ], [ -123.83257991484471, 40.596296582457065 ], [ -124.12128608336, 40.48359593087883 ], [ -124.39378166040615, 40.3483045928272 ], [ -124.64731122870919, 40.19184184816271 ], [ -124.87936508347416, 40.01583868606228 ], [ -125.08770511730408, 39.82211671652021 ], [ -125.2703851091221, 39.612665272836104 ], [ -125.42576541683815, 39.38961717369996 ], [ -125.5525222614583, 39.155223598933816 ], [ -125.64965194507218, 38.91182850391155 ], [ -125.71647046181684, 38.66184295782757 ], [ -125.75260903826418, 38.40771974415537 ], [ -125.75800617954594, 38.15192851148771 ], [ -125.73289680412344, 37.896931712705545 ], [ -125.67779902918376, 37.645161522703965 ], [ -125.59349912671317, 37.39899788164528 ], [ -125.48103511395225, 37.16074777315489 ], [ -125.34167937731078, 36.93262581563209 ], [ -125.17692066122217, 36.716736219976724 ], [ -124.98844568713437, 36.51505614817026 ], [ -124.77812060605783, 36.329420493626166 ], [ -124.54797243295081, 36.16150809518289 ], [ -124.30017056390395, 36.01282939111478 ], [ -124.03700843797262, 35.884715516646956 ], [ -123.76088537435982, 35.77830884731792 ], [ -123.47428859178562, 35.69455499039766 ], [ -123.17977539931903, 35.634196226848395 ], [ -122.87995553558731, 35.59776640658388 ], [ -122.57747362499973, 35.58558729977837 ], [ -122.27499171441217, 35.59776640658388 ], [ -121.97517185068044, 35.634196226848395 ], [ -121.68065865821384, 35.69455499039766 ], [ -121.39406187563965, 35.77830884731792 ], [ -121.11793881202686, 35.884715516646956 ], [ -120.85477668609552, 36.01282939111478 ], [ -120.60697481704867, 36.16150809518289 ], [ -120.37682664394164, 36.329420493626166 ], [ -120.16650156286511, 36.51505614817026 ], [ -119.9780265887773, 36.71673621997671 ], [ -119.81326787268868, 36.93262581563209 ], [ -119.67391213604722, 37.16074777315489 ], [ -119.5614481232863, 37.39899788164528 ], [ -119.47714822081572, 37.645161522703965 ], [ -119.42205044587604, 37.896931712705545 ], [ -119.39694107045352, 38.15192851148771 ], [ -119.4023382117353, 38.40771974415537 ], [ -119.43847678818264, 38.66184295782757 ], [ -119.5052953049273, 38.91182850391155 ], [ -119.60242498854116, 39.155223598933816 ], [ -119.72918183316133, 39.38961717369996 ], [ -119.88456214087736, 39.612665272836104 ], [ -120.0672421326954, 39.82211671652021 ], [ -120.27558216652533, 40.01583868606228 ], [ -120.5076360212903, 40.19184184816271 ], [ -120.76116558959333, 40.3483045928272 ], [ -121.03366116663948, 40.48359593087883 ], [ -121.32236733515477, 40.596296582457065 ], [ -121.62431423345818, 40.68521779095769 ], [ -121.93635376868622, 40.74941741973824 ], [ -122.2552001141461, 40.788212932495085 ], [ -122.57747362499973, 40.80119092188791 ] ] ]
  );
  drawCircle('doug-estimate', -104.90371345637227, 39.9807164547761, 300,
            [ [ [ -104.90371345637226, 42.58851826583087 ], [ -105.22598696722591, 42.57554027643805 ], [ -105.5448333126858, 42.536744763681206 ], [ -105.8568728479138, 42.47254513490065 ], [ -106.15881974621725, 42.38362392640003 ], [ -106.44752591473254, 42.27092327482179 ], [ -106.72002149177868, 42.13563193677016 ], [ -106.97355106008172, 41.97916919210567 ], [ -107.20560491484669, 41.803166030005244 ], [ -107.41394494867662, 41.609444060463176 ], [ -107.59662494049464, 41.399992616779066 ], [ -107.75200524821068, 41.17694451764292 ], [ -107.87876209283083, 40.94255094287678 ], [ -107.97589177644471, 40.69915584785451 ], [ -108.04271029318937, 40.44917030177053 ], [ -108.07884886963672, 40.195047088098335 ], [ -108.08424601091848, 39.93925585543067 ], [ -108.05913663549597, 39.68425905664851 ], [ -108.00403886055629, 39.43248886664693 ], [ -107.9197389580857, 39.18632522558824 ], [ -107.80727494532478, 38.94807511709785 ], [ -107.66791920868332, 38.719953159575056 ], [ -107.5031604925947, 38.504063563919686 ], [ -107.3146855185069, 38.30238349211322 ], [ -107.10436043743036, 38.11674783756913 ], [ -106.87421226432335, 37.94883543912585 ], [ -106.62641039527648, 37.80015673505774 ], [ -106.36324826934515, 37.67204286058992 ], [ -106.08712520573235, 37.565636191260886 ], [ -105.80052842315816, 37.481882334340625 ], [ -105.50601523069156, 37.42152357079136 ], [ -105.20619536695985, 37.38509375052684 ], [ -104.90371345637226, 37.37291464372133 ], [ -104.6012315457847, 37.38509375052684 ], [ -104.30141168205297, 37.42152357079136 ], [ -104.00689848958638, 37.481882334340625 ], [ -103.72030170701218, 37.565636191260886 ], [ -103.4441786433994, 37.67204286058992 ], [ -103.18101651746805, 37.80015673505774 ], [ -102.9332146484212, 37.94883543912585 ], [ -102.70306647531417, 38.11674783756913 ], [ -102.49274139423764, 38.30238349211322 ], [ -102.30426642014983, 38.50406356391967 ], [ -102.13950770406122, 38.719953159575056 ], [ -102.00015196741975, 38.94807511709785 ], [ -101.88768795465883, 39.18632522558824 ], [ -101.80338805218825, 39.43248886664693 ], [ -101.74829027724857, 39.68425905664851 ], [ -101.72318090182605, 39.93925585543067 ], [ -101.72857804310783, 40.195047088098335 ], [ -101.76471661955517, 40.44917030177053 ], [ -101.83153513629983, 40.69915584785451 ], [ -101.92866481991369, 40.94255094287678 ], [ -102.05542166453387, 41.17694451764292 ], [ -102.2108019722499, 41.399992616779066 ], [ -102.39348196406793, 41.609444060463176 ], [ -102.60182199789786, 41.803166030005244 ], [ -102.83387585266283, 41.97916919210567 ], [ -103.08740542096587, 42.13563193677016 ], [ -103.35990099801201, 42.27092327482179 ], [ -103.6486071665273, 42.38362392640003 ], [ -103.95055406483071, 42.47254513490065 ], [ -104.26259360005875, 42.536744763681206 ], [ -104.58143994551864, 42.57554027643805 ], [ -104.90371345637226, 42.58851826583087 ] ] ]
  );
  draw.changeMode("simple_select");
});

function showSubmitContainer() {
  document.getElementById("submit-container").style.display = "table";
  document.getElementById("pre-submit").style.display = "none";
}

function hideSubmitContainer() {
  document.getElementById("submit-container").style.display = "none";
  document.getElementById("pre-submit").style.display = "block";
}

document.getElementById("cancel-submit").addEventListener("click", hideSubmitContainer);
document.getElementById("pre-submit").addEventListener("click", showSubmitContainer);

const FIELDS = {
  'mom-center':'entry.273983659',
  'mom-radius':'entry.102031572',
  'chris-center':'entry.807037936',
  'chris-radius':'entry.1475102316',
  'haley-center':'entry.165577067',
  'haley-radius':'entry.1795473454',
  'devon-center':'entry.843745481',
  'devon-radius':'entry.1540621330',
  'doug-center':'entry.652395115',
  'doug-radius':'entry.88494659',
}

function submitEstimates() {
  const form = document.getElementById("submit");
  const inputs =
    Array.prototype.slice.call(document.getElementsByClassName("hidden-form-values"),
    0);
  for (const input of inputs) {
    form.removeChild(input);
  }
	for (const item of draw.getAll().features) {
    const person = item.id.split('-')[0];

    const center = document.createElement("input");
    center.type = "hidden";
    center.classList.add("hidden-form-values");
    center.name = FIELDS[person + "-center"];
    center.value = item.properties['center'];

    const radius = document.createElement("input");
    radius.type = "hidden";
    radius.classList.add("hidden-form-values");
    radius.name = FIELDS[person + "-radius"];
    radius.value = item.properties['radiusInKm'];

    form.append(center)
    form.append(radius)
	}
  hideSubmitContainer();
  return true;
}

document.getElementById('submit').addEventListener('submit', submitEstimates);

function updateSelection(e) {
  for (const item of document.getElementsByClassName("control-element")) {
    item.classList.remove("selected");
  }
  if (e.features.length == 0) {
    return;
  }
  const person = e.features[0].id.split('-')[0]
  document.getElementById(person).classList.add("selected")
}
